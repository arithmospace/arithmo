<!DOCTYPE html>
<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Arithmo - My Profile</title>

    <link rel="icon" type="image/png" href="assets/favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="assets/favicon/favicon.svg" />
    <link rel="shortcut icon" href="assets/favicon/favicon.ico" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://kit.fontawesome.com/d59a7ad26f.js" crossorigin="anonymous"></script>

    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Bungee&display=swap" rel="stylesheet" />

    <link rel="stylesheet" href="assets/moving-balls-bg.css" />
    <link rel="stylesheet" href="assets/common_style.css" />
    <link rel="stylesheet" href="assets/style.css">

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#ea2a33", "background-light": "#f8f6f6", "background-dark": "#211111" },
                    fontFamily: { "display": ["Lexend", "sans-serif"], "brand": ["Bungee", "cursive"] },
                    borderRadius: { "DEFAULT": "1rem", "lg": "2rem", "xl": "3rem", "full": "9999px" },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                },
            },
        }
    </script>
</head>

<body class="font-display moving-balls-bg bg-gray-50 flex flex-col min-h-screen">

    <div class="flex flex-col flex-1 w-full px-4 sm:px-6 lg:px-8">
        <div class="nav_container" id="nav_container_id"></div>

        <main class="flex-1 flex items-center justify-center py-12">

            <div
                class="relative w-full max-w-md bg-white/80 dark:bg-black/50 backdrop-blur-xl border border-white/60 shadow-2xl rounded-[2.5rem] p-8 sm:p-10 overflow-hidden text-center">

                <div
                    class="absolute -top-20 left-1/2 -translate-x-1/2 w-64 h-64 bg-primary/10 rounded-full blur-3xl pointer-events-none">
                </div>

                <div class="relative z-10 flex flex-col items-center mb-8">
                    <div
                        class="w-32 h-32 mb-4 bg-gradient-to-br from-white to-zinc-100 rounded-full flex items-center justify-center border-[6px] border-white shadow-xl animate-float">
                        <span class="text-6xl pt-1 pl-1">üöÄ</span>
                        <div class="absolute bottom-1 right-1 w-6 h-6 bg-green-500 rounded-full border-4 border-white shadow-sm"
                            title="Online"></div>
                    </div>

                    <h1 class="font-brand text-3xl text-zinc-800 dark:text-white mb-2" id="profile-name">
                        Loading...
                    </h1>

                    <div
                        class="inline-flex items-center gap-2 px-4 py-1.5 bg-zinc-100 border border-zinc-200 rounded-full text-xs font-bold text-zinc-500">
                        <i class="fa-regular fa-calendar"></i>
                        <span id="member-since">Joined: ...</span>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4 mb-10">
                    <div
                        class="bg-yellow-50/80 p-4 rounded-2xl border border-yellow-100/50 flex flex-col items-center hover:scale-105 transition-transform">
                        <div class="text-2xl mb-1">‚≠ê</div>
                        <span class="font-brand text-2xl text-zinc-800" id="stat-stars">0</span>
                        <span class="text-[10px] font-bold text-zinc-400 uppercase tracking-wide">Stars</span>
                    </div>

                    <div
                        class="bg-blue-50/80 p-4 rounded-2xl border border-blue-100/50 flex flex-col items-center hover:scale-105 transition-transform">
                        <div class="text-2xl mb-1">üèÖ</div>
                        <span class="font-brand text-2xl text-zinc-800" id="stat-badges">0</span>
                        <span class="text-[10px] font-bold text-zinc-400 uppercase tracking-wide">Badges</span>
                    </div>

                    <div
                        class="bg-green-50/80 p-4 rounded-2xl border border-green-100/50 flex flex-col items-center hover:scale-105 transition-transform">
                        <div class="text-2xl mb-1">üé®</div>
                        <span class="font-brand text-2xl text-zinc-800" id="stat-tokens">0</span>
                        <span class="text-[10px] font-bold text-zinc-400 uppercase tracking-wide">Tokens</span>
                    </div>
                </div>

                <div class="space-y-3">
                    <button onclick="showLogoutModal()"
                        class="w-full bg-white hover:bg-zinc-50 text-zinc-700 font-bold py-3.5 rounded-xl border-2 border-zinc-100 shadow-sm transition-all active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-arrow-right-from-bracket"></i>
                        Log Out
                    </button>

                    <button onclick="showResetModal()"
                        class="w-full text-red-500 hover:text-red-600 hover:bg-red-50 border-2 border-red-200 font-semibold py-3 rounded-xl transition-colors text-sm flex items-center justify-center gap-2">
                        <i class="fa-solid fa-trash-can"></i>
                        Reset Progress
                    </button>
                </div>

            </div>
        </main>
    </div>

    <div id="logout-modal"
        class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 transition-opacity duration-300 opacity-0">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl transform scale-95 transition-transform duration-300 text-center"
            id="logout-modal-content">
            <div
                class="w-16 h-16 bg-zinc-100 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl text-zinc-500">
                <i class="fa-solid fa-door-open"></i>
            </div>
            <h3 class="font-brand text-xl text-zinc-900 mb-2">Leaving so soon?</h3>
            <p class="text-zinc-500 text-sm mb-6">Your progress is saved. See you next time!</p>

            <div class="flex gap-3">
                <button onclick="closeLogoutModal()"
                    class="flex-1 px-4 py-3 rounded-xl font-bold text-zinc-600 bg-zinc-100 hover:bg-zinc-200 transition-colors">
                    Stay
                </button>
                <button onclick="confirmLogout()"
                    class="flex-1 px-4 py-3 rounded-xl font-bold bg-primary text-white hover:bg-red-600 shadow-lg transition-all">
                    Log Out
                </button>
            </div>
        </div>
    </div>

    <div id="reset-modal"
        class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-red-900/40 backdrop-blur-md p-4 transition-opacity duration-300 opacity-0">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl border-2 border-red-100 transform scale-95 transition-transform duration-300 text-center"
            id="reset-modal-content">
            <div
                class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl text-red-500 animate-bounce">
                <i class="fa-solid fa-triangle-exclamation"></i>
            </div>
            <h3 class="font-brand text-xl text-red-600 mb-2">Reset Everything?</h3>
            <p class="text-zinc-500 text-sm mb-6 leading-relaxed">
                This will <strong>permanently delete</strong> all your stars, badges, and level progress. You cannot
                undo this!
            </p>

            <div class="flex gap-3">
                <button onclick="closeResetModal()"
                    class="flex-1 px-4 py-3 rounded-xl font-bold text-zinc-600 bg-zinc-100 hover:bg-zinc-200 transition-colors">
                    Cancel
                </button>
                <button onclick="confirmReset()"
                    class="flex-1 px-4 py-3 rounded-xl font-bold bg-red-500 text-white hover:bg-red-600 shadow-lg shadow-red-500/30 transition-all">
                    Yes, Reset
                </button>
            </div>
        </div>
    </div>

    <script src="assets/moving-balls-bg.js"></script>
    <script src="assets/check-navbar.js"></script>
    <script src="assets/assets_common_script.js"></script>
    <script src="assets/script.js"></script>
    <script src="assets/progress-manager.js"></script>

    <script>
        // Load Profile Data
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('arithmo_jwt');

            if (!token) {
                setupGuestMode();
                return;
            }

            try {
                // 1. Fetch User Details
                const response = await fetch('https://arithmobackend.onrender.com/api/auth/profile', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (data.success && data.user) {
                    document.getElementById('profile-name').innerText = data.user.username || "Explorer";

                    if (data.user.joinedDate) {
                        try {
                            const date = new Date(data.user.joinedDate);
                            const formattedDate = date.toLocaleDateString('en-US', {
                                month: 'short',
                                year: 'numeric',
                                day: 'numeric'
                            });
                            document.getElementById('member-since').innerText = `Joined: ${formattedDate}`;
                        } catch (e) {
                            document.getElementById('member-since').innerText = "Unknown";
                        }
                    } else {
                        document.getElementById('member-since').innerText = "Unknown";
                    }
                } else {
                    handleLogout(); // Token invalid
                    return;
                }

                // 2. Load Stats
                loadStats();

            } catch (error) {
                console.error("Profile Load Error:", error);
                document.getElementById('profile-name').innerText = "Offline";
            }
        });

        async function loadStats() {
            if (window.ArithmoProgress) {
                await window.ArithmoProgress.ready();
                const progress = window.ArithmoProgress.getProgress();

                if (progress && progress.totals) {
                    animateValue("stat-stars", 0, progress.totals.totalStars || 0, 1500);
                    animateValue("stat-badges", 0, progress.totals.totalBadges || 0, 1500);
                    animateValue("stat-tokens", 0, progress.totals.totalTokens || 0, 1500);
                }
            }
        }

        function setupGuestMode() {
            document.getElementById('profile-name').innerText = "Guest Explorer";
            document.getElementById('member-since').innerText = "Joined: Today";

            const localData = JSON.parse(localStorage.getItem('arithmo_progress') || '{}');
            if (localData.totals) {
                document.getElementById('stat-stars').innerText = localData.totals.totalStars || 0;
                document.getElementById('stat-badges').innerText = localData.totals.totalBadges || 0;
                document.getElementById('stat-tokens').innerText = localData.totals.totalTokens || 0;
            }
        }

        // --- LOGOUT MODAL LOGIC ---
        function showLogoutModal() {
            const modal = document.getElementById('logout-modal');
            const content = document.getElementById('logout-modal-content');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
        }

        function closeLogoutModal() {
            const modal = document.getElementById('logout-modal');
            const content = document.getElementById('logout-modal-content');
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function confirmLogout() {
            localStorage.removeItem('arithmo_jwt');
            window.location.href = 'index.html';
        }

        // --- RESET MODAL LOGIC ---
        function showResetModal() {
            const modal = document.getElementById('reset-modal');
            const content = document.getElementById('reset-modal-content');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
        }

        function closeResetModal() {
            const modal = document.getElementById('reset-modal');
            const content = document.getElementById('reset-modal-content');
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        async function confirmReset() {
            if (window.ArithmoProgress) {
                const result = await window.ArithmoProgress.resetProgress();
                if (result.success) {
                    closeResetModal();
                    if (window.ArithmoToast) window.ArithmoToast.success("Reset Complete!");
                    else alert("Reset Complete!");
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    alert("Failed to reset. Try again.");
                }
            }
        }

        function animateValue(id, start, end, duration) {
            if (start === end) {
                document.getElementById(id).innerHTML = end;
                return;
            }
            const range = end - start;
            let current = start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / range));
            const obj = document.getElementById(id);

            const timer = setInterval(function () {
                current += increment;
                obj.innerHTML = current;
                if (current == end) {
                    clearInterval(timer);
                }
            }, stepTime);
        }
    </script>
</body>

</html>