<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Arithmo ‚Äì Level 5:Math Master Trail</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="../assets/favicon/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="../assets/favicon/favicon.svg" />
  <link rel="shortcut icon" href="../assets/favicon/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="../assets/favicon/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-title" content="Arithmo" />
  <link rel="manifest" href="../assets/favicon/site.webmanifest" />

  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Bungee&display=swap" rel="stylesheet">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#ea2a33"
          },
          fontFamily: {
            display: ["Lexend", "sans-serif"],
            brand: ["Bungee", "cursive"],
          }
        }
      }
    }
  </script>
  <style>
    /* ==================== MATH MASTER TRAIL LEVEL STYLES ==================== */
    .math-trail-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 1rem;
    }

    .progress-bar-container {
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .progress-bar {
      width: 100%;
      height: 24px;
      background: #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #ea2a33 0%, #ff6b6b 100%);
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 8px;
      color: white;
      font-size: 0.75rem;
      font-weight: bold;
    }

    .activity-card {
      background: white;
      border-radius: 2rem;
      padding: 2rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
      min-height: 500px;
      display: flex;
      flex-direction: column;
    }

    .activity-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .activity-title {
      font-family: 'Bungee', cursive;
      font-size: 2rem;
      color: #1f2937;
      margin-bottom: 0.5rem;
    }

    .activity-subtitle {
      font-size: 1.125rem;
      color: #806c6b;
    }

    .teaching-module {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border-radius: 1.5rem;
      padding: 2rem;
      margin-bottom: 2rem;
      border: 3px solid #fc7d7d;
    }

    .guide-character {
      width: 80px;
      height: 80px;
      background: #e90e0e;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      margin: 0 auto 1rem;
      box-shadow: 0 4px 12px rgba(233, 14, 14, 0.3);
    }

    .speech-bubble {
      background: white;
      border-radius: 1.5rem;
      padding: 1.5rem;
      position: relative;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-bottom: 1.5rem;
    }

    .speech-bubble::before {
      content: '';
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-bottom: 10px solid white;
    }

    .time-of-day-card {
      width: 140px;
      height: 140px;
      border-radius: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      transition: all 0.3s;
      cursor: pointer;
    }

    .time-of-day-card.active {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .time-icon {
      font-size: 3rem;
      margin-bottom: 0.5rem;
    }

    .coin-visual {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }

    .coin-visual:hover {
      transform: scale(1.1);
    }

    .value-scale {
      width: 300px;
      height: 40px;
      background: linear-gradient(to right, #dcfce7, #fef3c7, #fee2e2);
      border-radius: 20px;
      position: relative;
      margin: 2rem auto;
      border: 3px solid #d1d5db;
    }

    .scale-marker {
      position: absolute;
      top: -10px;
      width: 4px;
      height: 60px;
      background: #6b7280;
    }

    .scale-value {
      position: absolute;
      top: -35px;
      transform: translateX(-50%);
      font-weight: bold;
    }

    .size-object {
      width: 100px;
      height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      margin: 0.5rem;
      transition: all 0.3s;
      cursor: move;
    }

    .size-object.dragging {
      opacity: 0.5;
    }

    .size-zone {
      min-height: 150px;
      border: 3px dashed #d1d5db;
      border-radius: 1rem;
      padding: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      flex-wrap: wrap;
      background: #f9fafb;
      transition: all 0.3s;
    }

    .size-zone.active {
      border-color: #e92b0e;
      background: #f0f9ff;
    }

    .simple-clock {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      border: 8px solid #1f2937;
      position: relative;
      margin: 1rem auto;
      background: white;
    }

    .clock-center {
      position: absolute;
      width: 12px;
      height: 12px;
      background: #ea2a33;
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 3;
    }

    .hour-hand {
      position: absolute;
      width: 6px;
      height: 70px;
      background: #371f1f;
      top: 50%;
      left: 50%;
      transform-origin: bottom center;
      transform: translate(-50%, -100%) rotate(0deg);
      border-radius: 3px;
      z-index: 2;
    }

    .minute-hand {
      position: absolute;
      width: 4px;
      height: 90px;
      background: #6b7280;
      top: 50%;
      left: 50%;
      transform-origin: bottom center;
      transform: translate(-50%, -100%) rotate(0deg);
      border-radius: 2px;
      z-index: 1;
    }

    .clock-number {
      position: absolute;
      font-size: 1.5rem;
      font-weight: bold;
      color: #1f2937;
    }

    .measurement-block {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: bold;
      color: white;
      margin: 0.25rem;
    }

    .measurement-ruler {
      width: 300px;
      height: 40px;
      background: white;
      border: 3px solid #1f2937;
      border-radius: 8px;
      position: relative;
      margin: 1rem auto;
    }

    .ruler-tick {
      position: absolute;
      top: 0;
      width: 2px;
      height: 20px;
      background: #1f2937;
    }

    .ruler-number {
      position: absolute;
      top: -25px;
      transform: translateX(-50%);
      font-weight: bold;
      font-size: 0.875rem;
    }

    .btn-primary {
      background: #ea2a33;
      color: white;
      padding: 1rem 2.5rem;
      border-radius: 9999px;
      border: none;
      font-size: 1.125rem;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 6px 0px 0px #f22828;
      transition: all 0.2s;
      font-family: 'Lexend', sans-serif;
      text-transform: uppercase;
    }

    .btn-primary:hover {
      transform: translateY(2px);
      box-shadow: 0 4px 0px 0px #f22828;
    }

    .btn-primary:active {
      transform: translateY(6px);
      box-shadow: none;
    }

    .btn-secondary {
      background: white;
      color: #ea2a33;
      padding: 0.75rem 2rem;
      border-radius: 9999px;
      border: 2px solid #ea2a33;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Lexend', sans-serif;
    }

    .btn-secondary:hover {
      background: #f0f9ff;
    }

    .feedback-correct {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      border: 3px solid #10b981;
      border-radius: 1rem;
      padding: 1.5rem;
      text-align: center;
      margin: 1.5rem 0;
      animation: slideDown 0.4s ease;
    }

    .feedback-incorrect {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 3px solid #f59e0b;
      border-radius: 1rem;
      padding: 1.5rem;
      text-align: center;
      margin: 1.5rem 0;
      animation: gentleShake 0.5s ease;
    }

    .feedback-message {
      font-size: 1.25rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    .time-slot {
      width: 160px;
      height: 120px;
      border: 3px solid #d1d5db;
      border-radius: 1rem;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: white;
      transition: all 0.3s;
    }

    .time-slot.active {
      border-color: #ea2a33;
      background: #f0f9ff;
    }

    .coin-stack {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      margin: 0.5rem;
    }

    .coin-in-stack {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.25rem;
    }

    .size-comparison {
      display: flex;
      align-items: flex-end;
      justify-content: center;
      gap: 2rem;
      margin: 2rem 0;
    }

    .size-bar {
      width: 60px;
      background: linear-gradient(to top, #ea2a33, #fc7d7d);
      border-radius: 8px 8px 0 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 1.25rem;
    }

    .time-progress {
      width: 100%;
      height: 40px;
      background: #e5e7eb;
      border-radius: 20px;
      overflow: hidden;
      margin: 1rem 0;
    }

    .time-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #e91d0e, #f83838);
      transition: width 1s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes gentleShake {

      0%,
      100% {
        transform: translateX(0);
      }

      25% {
        transform: translateX(-4px);
      }

      75% {
        transform: translateX(4px);
      }
    }

    @keyframes pulse {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }
    }

    .rewards-container {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
      margin: 1rem 0;
    }

    .reward-badge {
      background: white;
      border-radius: 1rem;
      padding: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
      animation: bounce 0.6s ease;
    }

    @keyframes bounce {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-10px);
      }
    }

    .reward-icon {
      font-size: 2rem;
    }

    .completion-screen {
      text-align: center;
      padding: 3rem 2rem;
    }

    .completion-trophy {
      font-size: 6rem;
      margin-bottom: 1rem;
      animation: trophy-spin 1s ease;
    }

    @keyframes trophy-spin {
      0% {
        transform: rotate(0deg) scale(0);
      }

      50% {
        transform: rotate(180deg) scale(1.2);
      }

      100% {
        transform: rotate(360deg) scale(1);
      }
    }

    .completion-title {
      font-family: 'Bungee', cursive;
      font-size: 2.5rem;
      color: #1f2937;
      margin-bottom: 1rem;
    }

    .completion-message {
      font-size: 1.25rem;
      color: #6b7280;
      margin-bottom: 2rem;
    }

    .visual-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1rem;
      margin: 2rem 0;
      padding: 1.5rem;
      background: #f9fafb;
      border-radius: 1rem;
    }

    .drag-item {
      padding: 1rem;
      border: 2px solid #d1d5db;
      border-radius: 1rem;
      background: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: move;
      transition: all 0.2s;
    }

    .drag-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .drop-zone {
      min-height: 120px;
      border: 3px dashed #d1d5db;
      border-radius: 1rem;
      padding: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      justify-content: center;
      background: #f9fafb;
      transition: all 0.3s;
    }

    .drop-zone.active {
      border-color: #e90e0e;
      background: #f0f9ff;
    }

    @media (max-width: 640px) {
      .activity-card {
        padding: 1.5rem;
        min-height: 400px;
      }

      .activity-title {
        font-size: 1.5rem;
      }

      .simple-clock {
        width: 150px;
        height: 150px;
      }

      .value-scale {
        width: 250px;
      }

      .size-object {
        width: 80px;
        height: 80px;
      }

      .time-of-day-card {
        width: 120px;
        height: 120px;
      }
    }

    .number-input {
      width: 120px;
      height: 80px;
      font-size: 2.5rem;
      text-align: center;
      border: 4px solid #d1d5db;
      border-radius: 1rem;
      font-weight: bold;
      color: #1f2937;
      margin: 0 auto;
      display: block;
      transition: all 0.3s;
    }

    .number-input:focus {
      outline: none;
      border-color: #e90e0e;
      box-shadow: 0 0 0 4px rgba(233, 14, 14, 0.2);
    }

    .number-pad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
      max-width: 300px;
      margin: 1.5rem auto;
    }

    .number-pad-btn {
      aspect-ratio: 1;
      font-size: 2rem;
      font-weight: bold;
      border: none;
      border-radius: 1rem;
      background: white;
      border: 3px solid #d1d5db;
      cursor: pointer;
      transition: all 0.2s;
      color: #371f1f;
    }

    .number-pad-btn:hover {
      background: #e9200e;
      border-color: #e9200e;
      color: white;
      transform: scale(1.05);
    }

    .choice-button {
      padding: 1rem 2rem;
      border: 3px solid #d1d5db;
      border-radius: 1rem;
      background: white;
      font-size: 1.25rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin: 0.5rem;
      min-width: 120px;
    }

    .choice-button:hover {
      transform: scale(1.05);
    }

    .choice-button.correct {
      background: #d1fae5;
      border-color: #10b981;
      color: #065f46;
    }

    .choice-button.incorrect {
      background: #fef3c7;
      border-color: #f59e0b;
      color: #92400e;
    }

    /* ==================== PROGRESS SYNC STYLES ==================== */
    .sync-status {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      gap: 6px;
      pointer-events: none;
      transition: all 0.3s;
    }

    .sync-status.online {
      background: rgba(76, 175, 80, 0.9);
      color: white;
      animation: pulse 2s infinite;
    }

    .sync-status.syncing {
      background: rgba(33, 150, 243, 0.9);
      color: white;
      animation: pulse 1s infinite;
    }

    .sync-status.offline {
      background: rgba(255, 152, 0, 0.9);
      color: white;
    }

    .sync-status.error {
      background: rgba(244, 67, 54, 0.9);
      color: white;
    }

    @keyframes pulse {
      0% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }

      100% {
        opacity: 1;
      }
    }

    /* Progress restore notification */
    .progress-restored {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(76, 175, 80, 0.95);
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      z-index: 1000;
      animation: slideDown 0.5s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 8px;
    }
  </style>
</head>

<body class="font-display bg-gray-50 min-h-screen flex items-center justify-center">
  <div class="bg-white rounded-3xl shadow-xl p-8 max-w-xl w-full text-center">
    <h1 class="font-brand text-4xl mb-4">LEVEL 5</h1>
    <p class="text-lg mb-8">Math Master Trail ‚Äì Life Skills üó∫Ô∏è</p>

    <main class="flex flex-1 items-center justify-center py-8">
      <div id="math-trail-root" class="math-trail-container w-full"></div>
    </main>
  </div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // ==================== PROGRESS WRAPPER COMPONENT ====================
    function ProgressWrapper({ children, activityNum, onComplete, onRetry, onNext, isCompleted }) {
      // Get current level from URL
      const getCurrentLevel = () => {
        const match = window.location.pathname.match(/level-(\d+)/);
        return match ? parseInt(match[1]) : 1;
      };

      // Enhanced onComplete that saves progress
      const handleCompleteWithSave = async () => {
        const currentLevel = getCurrentLevel();

        // Calculate rewards for this activity
        const rewards = { tokens: 1 };
        if (activityNum === 1 || activityNum === 6) {
          rewards.badges = 1;
        }

        // Check if this completes the level (activity 10)
        const isLevelCompleted = activityNum === 10;

        // Save progress
        if (window.saveActivityProgress) {
          try {
            await window.saveActivityProgress(
              currentLevel,
              activityNum,
              rewards,
              isLevelCompleted
            );
            console.log(`‚úÖ Progress saved: Level ${currentLevel}, Activity ${activityNum}`);
          } catch (error) {
            console.error('‚ùå Failed to save progress:', error);
          }
        }

        // Call original onComplete
        if (onComplete) {
          onComplete(activityNum);
        }
      };

      // Enhanced onRetry that saves stars
      const handleRetryWithSave = () => {
        // Save star reward
        if (window.saveActivityProgress) {
          try {
            const currentLevel = getCurrentLevel();
            window.saveActivityProgress(
              currentLevel,
              activityNum,
              { stars: 1 },
              false
            );
          } catch (error) {
            console.error('Failed to save retry progress:', error);
          }
        }

        // Call original onRetry
        if (onRetry) {
          onRetry();
        }
      };

      // Clone the child component with enhanced handlers
      return React.cloneElement(children, {
        onComplete: handleCompleteWithSave,
        onRetry: handleRetryWithSave,
        onNext,
        isCompleted,
        activityNum
      });
    }

    // ==================== SYNC STATUS COMPONENT ====================
    function SyncStatus() {
      const [status, setStatus] = useState('online');
      const [message, setMessage] = useState('Synced');

      useEffect(() => {
        const updateStatus = () => {
          if (!window.ArithmoProgress) return;

          const syncStatus = window.ArithmoProgress.getSyncStatus();

          if (!syncStatus.isOnline) {
            setStatus('offline');
            setMessage('Offline');
          } else if (syncStatus.isSyncing) {
            setStatus('syncing');
            setMessage('Syncing...');
          } else if (syncStatus.queueLength > 0) {
            setStatus('syncing');
            setMessage(`${syncStatus.queueLength} pending`);
          } else {
            setStatus('online');
            setMessage('Synced');
          }
        };

        const interval = setInterval(updateStatus, 3000);
        updateStatus();

        return () => clearInterval(interval);
      }, []);

      if (!window.ArithmoProgress) return null;

      return (
        <div className={`sync-status ${status}`}>
          <span>{status === 'online' ? '‚úÖ' : status === 'syncing' ? 'üîÑ' : 'üì¥'}</span>
          <span>{message}</span>
        </div>
      );
    }

    // ==================== PROGRESS RESTORE NOTIFICATION ====================
    function ProgressRestoreNotification({ restoredCount }) {
      if (!restoredCount || restoredCount === 0) return null;

      const [visible, setVisible] = useState(true);

      useEffect(() => {
        const timer = setTimeout(() => {
          setVisible(false);
        }, 3000);

        return () => clearTimeout(timer);
      }, []);

      if (!visible) return null;

      return (
        <div className="progress-restored">
          <span>‚úÖ</span>
          <span>Restored {restoredCount} completed activities</span>
        </div>
      );
    }

    // ==================== PROGRESS BAR COMPONENT ====================
    function ProgressBar({ current, total, rewards }) {
      const percent = Math.round((current / total) * 100);

      return (
        <div className="progress-bar-container">
          <div className="flex justify-between items-center mb-2">
            <span className="font-bold text-lg">Your Progress</span>
            <span className="font-bold text-primary">{current}/{total} activities</span>
          </div>

          <div className="progress-bar">
            <div
              className="progress-fill"
              style={{ width: `${percent}%` }}
            >
              {percent}%
            </div>
          </div>

          {rewards && (
            <div className="flex justify-between mt-4">
              <div className="text-center">
                <div className="text-2xl">‚≠ê</div>
                <div className="text-sm font-bold">{rewards.stars || 0}</div>
                <div className="text-xs text-gray-500">Stars</div>
              </div>
              <div className="text-center">
                <div className="text-2xl">üèÖ</div>
                <div className="text-sm font-bold">{rewards.badges || 0}</div>
                <div className="text-xs text-gray-500">Badges</div>
              </div>
              <div className="text-center">
                <div className="text-2xl">üé®</div>
                <div className="text-sm font-bold">{rewards.tokens || 0}</div>
                <div className="text-xs text-gray-500">Tokens</div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ==================== MAIN APP COMPONENT ====================
    function MathMasterTrailLevel() {
      const [currentActivity, setCurrentActivity] = useState(1);
      const [completedActivities, setCompletedActivities] = useState([]);
      const [rewards, setRewards] = useState({ stars: 0, badges: 0, tokens: 0 });
      const [showCompletion, setShowCompletion] = useState(false);
      const [restoredCount, setRestoredCount] = useState(0);
      const [progressLoaded, setProgressLoaded] = useState(false);

      // Load progress on mount
      useEffect(() => {
        const loadProgress = async () => {
          if (window.ArithmoProgress) {
            try {
              const progress = await window.ArithmoProgress.getProgress();
              const currentLevel = getCurrentLevel();
              const levelProgress = progress?.levels?.[currentLevel];

              if (levelProgress) {
                // Restore completed activities
                if (levelProgress.completedActivities?.length > 0) {
                  setCompletedActivities(levelProgress.completedActivities);
                  setRestoredCount(levelProgress.completedActivities.length);

                  // Find next incomplete activity
                  const allActivities = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
                  const nextActivity = allActivities.find(a => !levelProgress.completedActivities.includes(a));
                  if (nextActivity) {
                    setCurrentActivity(nextActivity);
                  } else {
                    setCurrentActivity(10);
                  }
                }

                // Restore rewards
                if (levelProgress.rewards) {
                  setRewards(levelProgress.rewards);
                }

                // Check if level completed
                if (levelProgress.status === "completed") {
                  setShowCompletion(true);
                }
              }
            } catch (error) {
              console.error('Failed to load progress:', error);
            } finally {
              setProgressLoaded(true);
            }
          } else {
            setProgressLoaded(true);
          }
        };

        loadProgress();
      }, []);

      // Helper function to get current level
      const getCurrentLevel = () => {
        const match = window.location.pathname.match(/level-(\d+)/);
        return match ? parseInt(match[1]) : 1;
      };

      // Original onComplete handler
      const handleActivityComplete = (activityNum) => {
        if (!completedActivities.includes(activityNum)) {
          setCompletedActivities([...completedActivities, activityNum]);
          setRewards(prev => ({ ...prev, tokens: prev.tokens + 1 }));
          if (activityNum === 1 || activityNum === 6) {
            setRewards(prev => ({ ...prev, badges: prev.badges + 1 }));
          }

          // Check if level completed
          if (activityNum === 10) {
            setTimeout(() => setShowCompletion(true), 1000);
          }
        }
      };

      // Original onRetry handler
      const handleRetry = () => {
        setRewards(prev => ({ ...prev, stars: prev.stars + 1 }));
      };

      const nextActivity = () => {
        if (currentActivity < 10) {
          setCurrentActivity(currentActivity + 1);
        }
      };

      const finishLevel = () => {
        if (typeof window.completeLevel === 'function') {
          window.completeLevel();
        }
      };

      useEffect(() => {
        if (completedActivities.length === 10 && !showCompletion) {
          setShowCompletion(true);
        }
      }, [completedActivities]);

      if (showCompletion) {
        return <CompletionScreen rewards={rewards} onFinish={finishLevel} />;
      }

      return (
        <div>
          <SyncStatus />
          <ProgressRestoreNotification restoredCount={restoredCount} />
          <ProgressBar
            current={completedActivities.length}
            total={10}
            rewards={rewards}
          />
          {progressLoaded ? (
            <ActivityRenderer
              activityNum={currentActivity}
              onComplete={handleActivityComplete}
              onRetry={handleRetry}
              onNext={nextActivity}
              isCompleted={completedActivities.includes(currentActivity)}
            />
          ) : (
            <div className="activity-card">
              <div className="text-center py-10">
                <div className="text-4xl mb-4">‚è≥</div>
                <p className="text-lg">Loading your progress...</p>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ==================== ACTIVITY RENDERER ====================
    function ActivityRenderer({ activityNum, onComplete, onRetry, onNext, isCompleted }) {
      const activities = {
        1: Activity01_DayParts,
        2: Activity02_BeforeAfter,
        3: Activity03_ReadingHours,
        4: Activity04_CoinValues,
        5: Activity05_MoreOrLess,
        6: Activity06_MakingAmounts,
        7: Activity07_ValueScales,
        8: Activity08_LongShort,
        9: Activity09_SizeRulers,
        10: Activity10_MixedChallenge,
      };

      const ActivityComponent = activities[activityNum];

      return (
        <ProgressWrapper
          activityNum={activityNum}
          onComplete={onComplete}
          onRetry={onRetry}
          onNext={onNext}
          isCompleted={isCompleted}
        >
          <ActivityComponent />
        </ProgressWrapper>
      );
    }

    // ==================== ACTIVITY 1: DAY PARTS ====================
    function Activity01_DayParts({ onComplete, onNext, activityNum, isCompleted }) {
      const [step, setStep] = useState('teaching');
      const [selectedTime, setSelectedTime] = useState('');
      const [correctAnswers, setCorrectAnswers] = useState(0);

      const dayParts = [
        { id: 'morning', icon: 'üåÖ', label: 'Morning', color: '#fef3c7' },
        { id: 'afternoon', icon: '‚òÄÔ∏è', label: 'Afternoon', color: '#fde68a' },
        { id: 'evening', icon: 'üåá', label: 'Evening', color: '#fed7aa' },
        { id: 'night', icon: 'üåô', label: 'Night', color: '#c7d2fe' }
      ];

      const activities = [
        { id: 1, icon: 'üõèÔ∏è', label: 'Wake up', correctTime: 'morning' },
        { id: 2, icon: 'üçΩÔ∏è', label: 'Lunch', correctTime: 'afternoon' },
        { id: 3, icon: 'üìö', label: 'Homework', correctTime: 'afternoon' },
        { id: 4, icon: 'üåõ', label: 'Sleep', correctTime: 'night' }
      ];

      const currentActivity = activities[correctAnswers];

      const handleTimeSelect = (timeId) => {
        if (!currentActivity) return;

        setSelectedTime(timeId);

        if (timeId === currentActivity.correctTime) {
          setTimeout(() => {
            if (correctAnswers < activities.length - 1) {
              setCorrectAnswers(correctAnswers + 1);
              setSelectedTime('');
            } else {
              onComplete(activityNum);
            }
          }, 800);
        } else {
          setTimeout(() => {
            setSelectedTime('');
          }, 1000);
        }
      };

      if (step === 'teaching') {
        return (
          <div>
            <div className="activity-header">
              <h2 className="activity-title">Activity 1: Day Parts</h2>
              <p className="activity-subtitle">Morning, Afternoon, Evening, Night üåÖ</p>
            </div>
            <div className="teaching-module">
              <div className="guide-character">üë©‚Äçüè´</div>
              <div className="speech-bubble">
                <p className="text-lg mb-3">
                  <strong>Let's learn about different times of day!</strong>
                </p>
                <p className="text-base mb-3">
                  Each part of the day has special activities.
                </p>
                <p className="text-base">
                  Morning = üåÖ Sun rising<br />
                  Afternoon = ‚òÄÔ∏è Bright sun<br />
                  Evening = üåá Sunset<br />
                  Night = üåô Moon and stars
                </p>
              </div>
              <div className="visual-grid">
                {dayParts.map(part => (
                  <div key={part.id} className="time-of-day-card" style={{ background: part.color }}>
                    <div className="time-icon">{part.icon}</div>
                    <div className="font-bold text-lg">{part.label}</div>
                  </div>
                ))}
              </div>
            </div>
            <div className="text-center">
              <button className="btn-primary" onClick={() => setStep('practice')}>
                Let's Practice! üï∞Ô∏è
              </button>
            </div>
          </div>
        );
      }

      if (isCompleted) {
        return (
          <div className="text-center">
            <div className="feedback-correct">
              <p className="feedback-message">üéâ Time Expert!</p>
              <p>You know the different parts of the day!</p>
            </div>
            <button className="btn-primary" onClick={onNext}>
              Next Activity ‚Üí
            </button>
          </div>
        );
      }

      return (
        <div>
          <div className="activity-header">
            <h2 className="activity-title">Match the Activity</h2>
            <p className="activity-subtitle">
              When do we do this? {correctAnswers + 1} of {activities.length}
            </p>
          </div>

          <div className="text-center mb-6">
            <div className="text-5xl mb-4">{currentActivity.icon}</div>
            <p className="text-2xl font-bold">{currentActivity.label}</p>
            <p className="text-gray-600 mt-2">When does this happen?</p>
          </div>

          <div className="visual-grid">
            {dayParts.map(part => (
              <div
                key={part.id}
                className={`time-of-day-card ${selectedTime === part.id ? 'active' : ''}`}
                style={{ background: part.color }}
                onClick={() => handleTimeSelect(part.id)}
              >
                <div className="time-icon">{part.icon}</div>
                <div className="font-bold text-lg">{part.label}</div>
              </div>
            ))}
          </div>

          <div className="text-center mt-6">
            <div className="time-progress">
              <div className="time-progress-fill" style={{ width: `${(correctAnswers / activities.length) * 100}%` }}></div>
            </div>
            <p className="text-sm text-gray-600">
              Matched: {correctAnswers} of {activities.length}
            </p>
          </div>
        </div>
      );
    }

    // ==================== ACTIVITY 2: BEFORE & AFTER ====================
    function Activity02_BeforeAfter({ onComplete, onNext, activityNum, isCompleted }) {
      const [step, setStep] = useState('teaching');
      const [currentTask, setCurrentTask] = useState(0);
      const [selected, setSelected] = useState(null);

      const tasks = [
        {
          scenario: "Eating breakfast and going to school",
          events: ["üçΩÔ∏è Eat breakfast", "üéí Go to school"],
          correctOrder: 0 // First event is correct
        },
        {
          scenario: "Brushing teeth and going to bed",
          events: ["ü¶∑ Brush teeth", "üõèÔ∏è Go to bed"],
          correctOrder: 0
        },
        {
          scenario: "Finishing homework and playing",
          events: ["üìö Finish homework", "‚öΩ Play outside"],
          correctOrder: 0
        }
      ];

      const task = tasks[currentTask];

      const handleSelect = (index) => {
        setSelected(index);

        if (index === task.correctOrder) {
          setTimeout(() => {
            if (currentTask < tasks.length - 1) {
              setCurrentTask(currentTask + 1);
              setSelected(null);
            } else {
              onComplete(activityNum);
            }
          }, 1000);
        }
      };

      if (step === 'teaching') {
        return (
          <div>
            <div className="activity-header">
              <h2 className="activity-title">Activity 2: Before & After</h2>
              <p className="activity-subtitle">What happens first? ‚è∞</p>
            </div>
            <div className="teaching-module">
              <div className="guide-character">üë©‚Äçüè´</div>
              <div className="speech-bubble">
                <p className="text-lg mb-3">
                  <strong>Some things happen before others!</strong>
                </p>
                <p className="text-base mb-3">
                  We need to know what comes first.
                </p>
                <div className="flex justify-center items-center gap-4 my-4">
                  <div className="text-center">
                    <div className="text-4xl">ü¶∑</div>
                    <div className="font-bold">First</div>
                    <div className="text-2xl">‚Üì</div>
                  </div>
                  <div className="text-center">
                    <div className="text-4xl">üò¥</div>
                    <div className="font-bold">Then</div>
                  </div>
                </div>
                <p className="text-base">
                  We brush teeth BEFORE sleeping!
                </p>
              </div>
            </div>
            <div className="text-center">
              <button className="btn-primary" onClick={() => setStep('practice')}>
                Let's Try! ‚ÜóÔ∏è
              </button>
            </div>
          </div>
        );
      }

      if (isCompleted) {
        return (
          <div className="text-center">
            <div className="feedback-correct">
              <p className="feedback-message">üéâ Sequence Master!</p>
              <p>You understand before and after!</p>
            </div>
            <button className="btn-primary" onClick={onNext}>
              Next Activity ‚Üí
            </button>
          </div>
        );
      }

      return (
        <div>
          <div className="activity-header">
            <h2 className="activity-title">What Comes First?</h2>
            <p className="activity-subtitle">
              Task {currentTask + 1} of {tasks.length}
            </p>
          </div>

          <div className="text-center mb-6">
            <p className="text-xl font-bold mb-4">{task.scenario}</p>
            <p className="text-gray-600">Which happens FIRST?</p>
          </div>

          <div className="space-y-4">
            {task.events.map((event, index) => (
              <button
                key={index}
                className={`choice-button w-full ${selected === index ? (index === task.correctOrder ? 'correct' : 'incorrect') : ''}`}
                onClick={() => handleSelect(index)}
              >
                <div className="text-3xl mb-2">{event.split(' ')[0]}</div>
                <div className="text-lg">{event.split(' ').slice(1).join(' ')}</div>
              </button>
            ))}
          </div>

          <div className="text-center mt-6">
            <div className="flex justify-center gap-2">
              {tasks.map((_, i) => (
                <div
                  key={i}
                  className={`w-4 h-4 rounded-full ${i < currentTask ? 'bg-green-500' : i === currentTask ? 'bg-blue-500' : 'bg-gray-300'}`}
                />
              ))}
            </div>
          </div>
        </div>
      );
    }

    // ==================== REDESIGNED ACTIVITY 3: CLOCK MASTER ====================
    function Activity03_ReadingHours({ onComplete, onNext, activityNum, isCompleted }) {
      const [step, setStep] = useState('teaching'); // 'teaching', 'practice'
      const [difficulty, setDifficulty] = useState(1); // 1: Hours, 2: O'Clock, 3: Half-Past
      const [currentProblem, setCurrentProblem] = useState(0);
      const [selectedAnswer, setSelectedAnswer] = useState({ h: '', m: '' });
      const [feedback, setFeedback] = useState(null);

      const levelProblems = [
        // Level 1: Just Hours
        { h: 4, m: 0, label: "4:00" },
        { h: 10, m: 0, label: "10:00" },
        // Level 2: Hour + Minute at 12
        { h: 1, m: 0, label: "1:00" },
        { h: 7, m: 0, label: "7:00" },
        // Level 3: Hour + Minute at 6 (Half Past)
        { h: 2, m: 30, label: "2:30" },
        { h: 11, m: 30, label: "11:30" }
      ];

      const currentTask = levelProblems[currentProblem];

      const checkAnswer = () => {
        const isCorrect = parseInt(selectedAnswer.h) === currentTask.h &&
          parseInt(selectedAnswer.m) === currentTask.m;

        if (isCorrect) {
          setFeedback('correct');
          setTimeout(() => {
            if (currentProblem < levelProblems.length - 1) {
              setCurrentProblem(prev => prev + 1);
              setSelectedAnswer({ h: '', m: '' });
              setFeedback(null);
              // Increase difficulty visual state
              if (currentProblem === 1) setDifficulty(2);
              if (currentProblem === 3) setDifficulty(3);
            } else {
              onComplete(activityNum);
            }
          }, 1500);
        } else {
          setFeedback('incorrect');
          setTimeout(() => setFeedback(null), 1000);
        }
      };

      const ClockDisplay = ({ hour, minute }) => {
        const hRotation = (hour * 30) + (minute * 0.5);
        const mRotation = minute * 6;

        return (
          <div className="relative w-64 h-64 mx-auto mb-8 bg-white rounded-full border-[10px] border-gray-800 shadow-2xl flex items-center justify-center">
            {/* Center Point */}
            <div className="absolute w-4 h-4 bg-black rounded-full z-40"></div>

            {/* Hour Hand (Short/Red) */}
            <div
              className="absolute w-2.5 h-16 bg-red-600 rounded-full origin-bottom z-30 transition-transform duration-1000"
              style={{ bottom: '50%', transform: `rotate(${hRotation}deg)` }}
            ></div>

            {/* Minute Hand (Long/Blue) */}
            {(difficulty > 1 || currentProblem > 1) && (
              <div
                className="absolute w-1.5 h-24 bg-blue-600 rounded-full origin-bottom z-20 transition-transform duration-1000"
                style={{ bottom: '50%', transform: `rotate(${mRotation}deg)` }}
              ></div>
            )}

            {/* All 12 Numbers */}
            {[...Array(12)].map((_, i) => {
              const num = i + 1;
              const angle = num * 30;
              return (
                <div
                  key={num}
                  className="absolute font-bold text-xl text-gray-800"
                  style={{
                    transform: `rotate(${angle}deg) translate(0, -95px) rotate(-${angle}deg)`
                  }}
                >
                  {num}
                </div>
              );
            })}
          </div>
        );
      };

      if (step === 'teaching') {
        return (
          <div className="animate-in slide-in-from-bottom duration-500">
            <div className="activity-header">
              <h2 className="activity-title text-indigo-600">How to Read Time üïµÔ∏è‚Äç‚ôÇÔ∏è</h2>
            </div>
            <div className="teaching-module bg-indigo-50 border-indigo-200">
              <div className="guide-character bg-indigo-500 text-white">üí°</div>
              <div className="space-y-4 text-gray-700">
                <div className="flex items-center gap-3">
                  <div className="w-8 h-4 bg-red-600 rounded"></div>
                  <p><strong>Short Red Hand:</strong> Points to the <strong>Hour</strong>.</p>
                </div>
                <div className="flex items-center gap-3">
                  <div className="w-12 h-2 bg-blue-600 rounded"></div>
                  <p><strong>Long Blue Hand:</strong> Points to the <strong>Minutes</strong>.</p>
                </div>
                <div className="p-4 bg-white rounded-xl border-l-4 border-indigo-500 italic">
                  "If the long hand is at 12, it's 00 minutes. If it's at 6, it's 30 minutes!"
                </div>
              </div>
            </div>
            <button className="btn-primary w-full" onClick={() => setStep('practice')}>Start the Challenge!</button>
          </div>
        );
      }

      if (isCompleted) {
        return (
          <div className="text-center py-10">
            <div className="feedback-correct">
              <p className="feedback-message">üïí Clock Master!</p>
              <p>You can read time correctly!</p>
            </div>
            <button className="btn-primary mt-6" onClick={onNext}>
              Next Activity ‚Üí
            </button>
          </div>
        );
      }


      return (
        <div className="flex flex-col items-center">
          <div className="text-center mb-4">
            <span className={`px-4 py-1 rounded-full text-xs font-bold uppercase tracking-widest ${difficulty === 1 ? 'bg-green-100 text-green-700' :
              difficulty === 2 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'
              }`}>
              Difficulty: {difficulty === 1 ? 'Easy' : difficulty === 2 ? 'Medium' : 'Hard'}
            </span>
            <h2 className="text-2xl font-bold mt-2">What time is shown?</h2>
          </div>

          <ClockDisplay hour={currentTask.h} minute={currentTask.m} />

          <div className="flex items-center gap-4 mb-6">
            <input
              type="number"
              placeholder="HH"
              className="w-20 h-16 text-3xl text-center border-4 border-red-200 rounded-2xl focus:border-red-500 outline-none"
              value={selectedAnswer.h}
              onChange={(e) => setSelectedAnswer({ ...selectedAnswer, h: e.target.value })}
            />
            <span className="text-4xl font-bold">:</span>
            <input
              type="number"
              placeholder="MM"
              className="w-20 h-16 text-3xl text-center border-4 border-blue-200 rounded-2xl focus:border-blue-500 outline-none"
              value={selectedAnswer.m}
              onChange={(e) => setSelectedAnswer({ ...selectedAnswer, m: e.target.value })}
            />
          </div>

          {feedback === 'correct' && <div className="text-green-600 font-bold mb-4 animate-bounce">‚ú® Perfect! Moving to next...</div>}
          {feedback === 'incorrect' && <div className="text-red-500 font-bold mb-4 animate-shake">Try again! Look at the hands.</div>}

          <button
            className="btn-primary"
            onClick={checkAnswer}
            disabled={!selectedAnswer.h || selectedAnswer.m === ''}
          >
            Check Time Check ‚úÖ
          </button>

          <div className="mt-8 flex gap-2">
            {levelProblems.map((_, i) => (
              <div key={i} className={`h-2 w-10 rounded-full ${i <= currentProblem ? 'bg-indigo-500' : 'bg-gray-200'}`} />
            ))}
          </div>
        </div>
      );
    }
    // ==================== ACTIVITY 4: COIN VALUES ====================
    function Activity04_CoinValues({ onComplete, onNext, activityNum, isCompleted }) {
      const [step, setStep] = useState('teaching');
      const [currentCoin, setCurrentCoin] = useState(0);
      const [selectedValue, setSelectedValue] = useState(null);

      const coins = [
        { value: 1, color: '#fbbf24', size: '60px', label: 'One' },
        { value: 2, color: '#f59e0b', size: '70px', label: 'Two' },
        { value: 5, color: '#d97706', size: '80px', label: 'Five' },
        { value: 10, color: '#b45309', size: '90px', label: 'Ten' }
      ];

      const coin = coins[currentCoin];
      const valueOptions = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];

      const handleValueSelect = (value) => {
        setSelectedValue(value);

        if (value === coin.value) {
          setTimeout(() => {
            if (currentCoin < coins.length - 1) {
              setCurrentCoin(currentCoin + 1);
              setSelectedValue(null);
            } else {
              onComplete(activityNum);
            }
          }, 1000);
        }
      };

      if (step === 'teaching') {
        return (
          <div>
            <div className="activity-header">
              <h2 className="activity-title">Activity 4: Coin Values</h2>
              <p className="activity-subtitle">How much is each coin worth? üí∞</p>
            </div>
            <div className="teaching-module">
              <div className="guide-character">üë©‚Äçüè´</div>
              <div className="speech-bubble">
                <p className="text-lg mb-3">
                  <strong>Coins have different values!</strong>
                </p>
                <p className="text-base mb-3">
                  Bigger coins are usually worth more.
                </p>
                <div className="flex justify-center items-end gap-4 my-4">
                  {coins.map((c, i) => (
                    <div key={i} className="text-center">
                      <div
                        className="coin-visual mx-auto mb-2"
                        style={{
                          background: c.color,
                          width: c.size,
                          height: c.size
                        }}
                      >
                        {c.value}
                      </div>
                      <div className="font-bold">Value: {c.value}</div>
                    </div>
                  ))}
                </div>
                <p className="text-base">
                  The number shows how much it's worth!
                </p>
              </div>
            </div>
            <div className="text-center">
              <button className="btn-primary" onClick={() => setStep('practice')}>
                Let's Learn Values! üíµ
              </button>
            </div>
          </div>
        );
      }

      if (isCompleted) {
        return (
          <div className="text-center">
            <div className="feedback-correct">
              <p className="feedback-message">üéâ Coin Expert!</p>
              <p>You know coin values!</p>
            </div>
            <button className="btn-primary" onClick={onNext}>
              Next Activity ‚Üí
            </button>
          </div>
        );
      }

      return (
        <div>
          <div className="activity-header">
            <h2 className="activity-title">What's This Coin Worth?</h2>
            <p className="activity-subtitle">
              Coin {currentCoin + 1} of {coins.length}
            </p>
          </div>

          <div className="text-center mb-6">
            <div
              className="coin-visual mx-auto mb-4"
              style={{
                background: coin.color,
                width: coin.size,
                height: coin.size,
                fontSize: '3rem'
              }}
            >
              ?
            </div>
            <p className="text-xl font-bold">{coin.label} Coin</p>
          </div>

          <div className="number-pad" style={{ gridTemplateColumns: 'repeat(5, 1fr)' }}>
            {valueOptions.map(value => (
              <button
                key={value}
                className={`number-pad-btn ${selectedValue === value ? (value === coin.value ? 'correct' : 'incorrect') : ''}`}
                onClick={() => handleValueSelect(value)}
              >
                {value}
              </button>
            ))}
          </div>

          <div className="text-center mt-4">
            <div className="flex justify-center gap-2">
              {coins.map((_, i) => (
                <div
                  key={i}
                  className={`w-4 h-4 rounded-full ${i < currentCoin ? 'bg-green-500' : i === currentCoin ? 'bg-yellow-500' : 'bg-gray-300'}`}
                />
              ))}
            </div>
          </div>
        </div>
      );
    }

    // ==================== ACTIVITY 5: MORE OR LESS ====================
    function Activity05_MoreOrLess({ onComplete, onNext, activityNum, isCompleted }) {
      const [step, setStep] = useState('teaching');
      const [currentComparison, setCurrentComparison] = useState(0);
      const [selected, setSelected] = useState(null);

      const comparisons = [
        {
          left: [1, 1, 1], // 3 coins
          right: [1, 1],    // 2 coins
          correct: 'left',  // Left has more
          question: "Which side has MORE coins?"
        },
        {
          left: [5],        // 1 coin (value 5)
          right: [2, 2],    // 2 coins (total 4)
          correct: 'left',  // Left has more value
          question: "Which side is worth MORE?"
        },
        {
          left: [1, 1, 1, 1], // 4 coins
          right: [10],         // 1 coin (value 10)
          correct: 'right',    // Right has more value
          question: "Which side is worth MORE?"
        },
        {
          left: [2, 2, 2], // 3 coins (total 6)
          right: [5, 1],    // 2 coins (total 6)
          correct: 'equal', // Equal value
          question: "Are they EQUAL or DIFFERENT?"
        }
      ];

      const comparison = comparisons[currentComparison];

      const calculateTotal = (coins) => {
        return coins.reduce((sum, coin) => sum + coin, 0);
      };

      const handleSelect = (choice) => {
        setSelected(choice);

        if (choice === comparison.correct) {
          setTimeout(() => {
            if (currentComparison < comparisons.length - 1) {
              setCurrentComparison(currentComparison + 1);
              setSelected(null);
            } else {
              onComplete(activityNum);
            }
          }, 1000);
        }
      };

      if (step === 'teaching') {
        return (
          <div>
            <div className="activity-header">
              <h2 className="activity-title">Activity 5: More or Less</h2>
              <p className="activity-subtitle">Comparing values ‚öñÔ∏è</p>
            </div>
            <div className="teaching-module">
              <div className="guide-character">üë©‚Äçüè´</div>
              <div className="speech-bubble">
                <p className="text-lg mb-3">
                  <strong>Let's compare values!</strong>
                </p>
                <p className="text-base mb-3">
                  We can see which side has more.
                </p>
                <div className="flex justify-center items-end gap-8 my-6">
                  <div className="text-center">
                    <div className="coin-stack">
                      {[1, 1, 1].map((value, i) => (
                        <div key={i} className="coin-in-stack" style={{ background: '#fbbf24' }}>
                          {value}
                        </div>
                      ))}
                    </div>
                    <div className="font-bold mt-2">3 coins</div>
                  </div>
                  <div className="text-3xl font-bold">VS</div>
                  <div className="text-center">
                    <div className="coin-stack">
                      {[1, 1].map((value, i) => (
                        <div key={i} className="coin-in-stack" style={{ background: '#fbbf24' }}>
                          {value}
                        </div>
                      ))}
                    </div>
                    <div className="font-bold mt-2">2 coins</div>
                  </div>
                </div>
                <p className="text-base">
                  Left side has MORE coins!
                </p>
              </div>
            </div>
            <div className="text-center">
              <button className="btn-primary" onClick={() => setStep('practice')}>
                Let's Compare! ‚ÜîÔ∏è
              </button>
            </div>
          </div>
        );
      }

      if (isCompleted) {
        return (
          <div className="text-center">
            <div className="feedback-correct">
              <p className="feedback-message">üéâ Comparison Pro!</p>
              <p>You can compare values!</p>
            </div>
            <button className="btn-primary" onClick={onNext}>
              Next Activity ‚Üí
            </button>
          </div>
        );
      }

      return (
        <div>
          <div className="activity-header">
            <h2 className="activity-title">{comparison.question}</h2>
            <p className="activity-subtitle">
              Comparison {currentComparison + 1} of {comparisons.length}
            </p>
          </div>

          <div className="flex justify-center items-end gap-8 my-8">
            <div className="text-center">
              <div className="coin-stack">
                {comparison.left.map((value, i) => (
                  <div key={i} className="coin-in-stack" style={{ background: '#fbbf24' }}>
                    {value}
                  </div>
                ))}
              </div>
              <div className="font-bold mt-2">
                {comparison.left.length} coin{comparison.left.length !== 1 ? 's' : ''}
              </div>
            </div>

            <div className="text-3xl font-bold">VS</div>

            <div className="text-center">
              <div className="coin-stack">
                {comparison.right.map((value, i) => (
                  <div key={i} className="coin-in-stack" style={{ background: '#fbbf24' }}>
                    {value}
                  </div>
                ))}
              </div>
              <div className="font-bold mt-2">
                {comparison.right.length} coin{comparison.right.length !== 1 ? 's' : ''}
              </div>
            </div>
          </div>

          <div className="space-y-3">
            {comparison.correct === 'equal' ? (
              <>
                <button
                  className={`choice-button ${selected === 'equal' ? 'correct' : ''}`}
                  onClick={() => handleSelect('equal')}
                >
                  <div className="text-2xl">‚öñÔ∏è</div>
                  <div className="font-bold">They are EQUAL</div>
                </button>
                <button
                  className={`choice-button ${selected === 'different' ? 'incorrect' : ''}`}
                  onClick={() => handleSelect('different')}
                >
                  <div className="text-2xl">‚ÜîÔ∏è</div>
                  <div className="font-bold">They are DIFFERENT</div>
                </button>
              </>
            ) : (
              <>
                <button
                  className={`choice-button ${selected === 'left' ? (comparison.correct === 'left' ? 'correct' : 'incorrect') : ''}`}
                  onClick={() => handleSelect('left')}
                >
                  <div className="text-2xl">‚¨ÖÔ∏è</div>
                  <div className="font-bold">LEFT side has more</div>
                </button>
                <button
                  className={`choice-button ${selected === 'right' ? (comparison.correct === 'right' ? 'correct' : 'incorrect') : ''}`}
                  onClick={() => handleSelect('right')}
                >
                  <div className="text-2xl">‚û°Ô∏è</div>
                  <div className="font-bold">RIGHT side has more</div>
                </button>
              </>
            )}
          </div>
        </div>
      );
    }

    // ==================== ACTIVITY 6: MAKING AMOUNTS ====================
    function Activity06_MakingAmounts({ onComplete, onNext, activityNum, isCompleted }) {
      const [step, setStep] = useState('teaching');
      const [currentTarget, setCurrentTarget] = useState(0);
      const [selectedCoins, setSelectedCoins] = useState([]);
      const [total, setTotal] = useState(0);

      const targets = [5, 7, 10, 12];
      const coinOptions = [1, 2, 5];

      const target = targets[currentTarget];

      const handleCoinClick = (coinValue) => {
        const newSelected = [...selectedCoins, coinValue];
        const newTotal = newSelected.reduce((sum, coin) => sum + coin, 0);

        setSelectedCoins(newSelected);
        setTotal(newTotal);

        if (newTotal === target) {
          setTimeout(() => {
            if (currentTarget < targets.length - 1) {
              setCurrentTarget(currentTarget + 1);
              setSelectedCoins([]);
              setTotal(0);
            } else {
              onComplete(activityNum);
            }
          }, 1000);
        } else if (newTotal > target) {
          setTimeout(() => {
            setSelectedCoins([]);
            setTotal(0);
          }, 800);
        }
      };

      if (step === 'teaching') {
        return (
          <div>
            <div className="activity-header">
              <h2 className="activity-title">Activity 7: Making Amounts</h2>
              <p className="activity-subtitle">Reaching target values üéØ</p>
            </div>
            <div className="teaching-module">
              <div className="guide-character">üë©‚Äçüè´</div>
              <div className="speech-bubble">
                <p className="text-lg mb-3">
                  <strong>We can combine coins to make amounts!</strong>
                </p>
                <p className="text-base mb-3">
                  Click coins to add them up.
                </p>
                <div className="my-6">
                  <div className="flex justify-center gap-4 mb-4">
                    <div className="coin-visual" style={{ background: '#fbbf24' }}>1</div>
                    <div className="text-3xl">+</div>
                    <div className="coin-visual" style={{ background: '#f59e0b' }}>2</div>
                    <div className="text-3xl">+</div>
                    <div className="coin-visual" style={{ background: '#f59e0b' }}>2</div>
                    <div className="text-3xl">=</div>
                    <div className="text-3xl font-bold text-green-600">5</div>
                  </div>
                  <p className="text-base">
                    1 + 2 + 2 = 5
                  </p>
                </div>
              </div>
            </div>
            <div className="text-center">
              <button className="btn-primary" onClick={() => setStep('practice')}>
                Let's Make Amounts! ‚ûï
              </button>
            </div>
          </div>
        );
      }

      if (isCompleted) {
        return (
          <div className="text-center">
            <div className="feedback-correct">
              <p className="feedback-message">üéâ Amount Maker!</p>
              <p>You can make amounts with coins!</p>
            </div>
            <button className="btn-primary" onClick={onNext}>
              Next Activity ‚Üí
            </button>
          </div>
        );
      }

      return (
        <div>
          <div className="activity-header">
            <h2 className="activity-title">Make This Amount: {target}</h2>
            <p className="activity-subtitle">
              Target {currentTarget + 1} of {targets.length}
            </p>
          </div>

          <div className="text-center mb-6">
            <div className="text-4xl font-bold mb-2">Target: {target}</div>
            <div className="text-2xl">Your total: {total}</div>
            <div className={`text-lg mt-2 ${total === target ? 'text-green-600 font-bold' : total > target ? 'text-red-600' : 'text-gray-600'}`}>
              {total === target ? 'üéØ Perfect!' : total > target ? 'Too much!' : 'Add more coins...'}
            </div>
          </div>

          <div className="flex justify-center gap-6 mb-8">
            {coinOptions.map(value => (
              <div key={value} className="text-center">
                <div
                  className="coin-visual cursor-pointer hover:scale-110 transition-transform"
                  style={{
                    background: value === 1 ? '#fbbf24' : value === 2 ? '#f59e0b' : '#d97706'
                  }}
                  onClick={() => handleCoinClick(value)}
                >
                  {value}
                </div>
                <div className="mt-2 font-bold">Value: {value}</div>
              </div>
            ))}
          </div>

          <div className="text-center">
            <div className="text-xl font-bold mb-2">Your coins:</div>
            <div className="flex justify-center gap-2 flex-wrap">
              {selectedCoins.map((value, index) => (
                <div
                  key={index}
                  className="coin-in-stack"
                  style={{
                    background: value === 1 ? '#fbbf24' : value === 2 ? '#f59e0b' : '#d97706'
                  }}
                >
                  {value}
                </div>
              ))}
              {selectedCoins.length === 0 && (
                <div className="text-gray-400 italic">No coins selected yet</div>
              )}
            </div>
            {selectedCoins.length > 0 && (
              <div className="mt-4">
                <button
                  className="btn-secondary"
                  onClick={() => {
                    setSelectedCoins([]);
                    setTotal(0);
                  }}
                >
                  Clear Coins üóëÔ∏è
                </button>
              </div>
            )}
          </div>
        </div>
      );
    }

    // ==================== ACTIVITY 7: WEIGHT SCALES ====================
    function Activity07_ValueScales({ onComplete, onNext, activityNum, isCompleted }) {
      const [step, setStep] = useState('teaching');
      const [currentTask, setCurrentTask] = useState(0);
      const [selection, setSelection] = useState(null);
      const [feedback, setFeedback] = useState(null);

      const tasks = [
        {
          left: { icon: "ü™∂", name: "Feather", weight: 1 },
          right: { icon: "üß±", name: "Brick", weight: 10 },
          question: "Which one is HEAVIER?",
          answer: "right"
        },
        {
          left: { icon: "üêò", name: "Elephant", weight: 50 },
          right: { icon: "üê≠", name: "Mouse", weight: 2 },
          question: "Which one is LIGHTER?",
          answer: "right"
        },
        {
          left: { icon: "üçé", name: "Apple", weight: 5 },
          right: { icon: "üö≤", name: "Bicycle", weight: 20 },
          question: "Which one is HEAVIER?",
          answer: "right"
        }
      ];

      const task = tasks[currentTask];

      const handleChoice = (side) => {
        if (feedback) return;
        setSelection(side);

        if (side === task.answer) {
          setFeedback('correct');
          setTimeout(() => {
            if (currentTask < tasks.length - 1) {
              setCurrentTask(currentTask + 1);
              setSelection(null);
              setFeedback(null);
            } else {
              onComplete(activityNum);
            }
          }, 1500);
        } else {
          setFeedback('incorrect');
          setTimeout(() => {
            setFeedback(null);
            setSelection(null);
          }, 1000);
        }
      };

      const BalanceScale = ({ leftWeight, rightWeight }) => {
        const tilt = leftWeight > rightWeight ? -15 : leftWeight < rightWeight ? 15 : 0;
        return (
          <div className="relative w-64 h-48 mx-auto mt-10 mb-4 flex flex-col items-center">
            {/* Scale Beam */}
            <div
              className="w-full h-3 bg-gray-700 rounded-full transition-transform duration-700 ease-in-out relative z-10"
              style={{ transform: `rotate(${tilt}deg)` }}
            >
              {/* Left Pan */}
              <div className="absolute left-0 -bottom-2 w-16 h-16 bg-amber-400 rounded-b-full border-b-4 border-amber-600 flex items-center justify-center text-3xl" style={{ transform: `rotate(${-tilt}deg) translateY(20px)` }}>
                {task.left.icon}
              </div>
              {/* Right Pan */}
              <div className="absolute right-0 -bottom-2 w-16 h-16 bg-amber-400 rounded-b-full border-b-4 border-amber-600 flex items-center justify-center text-3xl" style={{ transform: `rotate(${-tilt}deg) translateY(20px)` }}>
                {task.right.icon}
              </div>
            </div>
            {/* Scale Base */}
            <div className="w-8 h-32 bg-gray-400 rounded-t-lg -mt-1 shadow-md"></div>
            <div className="w-24 h-4 bg-gray-500 rounded-full"></div>
          </div>
        );
      };

      if (step === 'teaching') {
        return (
          <div className="animate-in fade-in zoom-in duration-500">
            <div className="activity-header">
              <h2 className="activity-title text-orange-600">Heavy vs. Light ‚öñÔ∏è</h2>
            </div>
            <div className="teaching-module border-orange-200 bg-orange-50">
              <div className="guide-character bg-orange-500">‚öñÔ∏è</div>
              <div className="speech-bubble">
                <p className="text-lg text-center font-medium">
                  The <strong>Heavy</strong> object pushes the scale <strong>Down</strong>.<br />
                  The <strong>Light</strong> object stays <strong>Up</strong>!
                </p>
                <BalanceScale leftWeight={1} rightWeight={10} />
                <p className="text-center font-bold text-orange-700 mt-4">The Brick is Heavier!</p>
              </div>
            </div>
            <button className="btn-primary w-full" onClick={() => setStep('practice')}>Start Sorting! ‚Üí</button>
          </div>
        );
      }

      if (isCompleted) {
        return (
          <div className="text-center py-10">
            <div className="feedback-correct">
              <div className="text-6xl mb-4">üèãÔ∏è‚Äç‚ôÇÔ∏è</div>
              <p className="feedback-message">Strong Work!</p>
              <p className="text-gray-600">You can tell what's heavy and what's light!</p>
            </div>
            <button className="btn-primary mt-6" onClick={onNext}>Next Skill ‚Üí</button>
          </div>
        );
      }

      return (
        <div className="animate-in slide-in-from-right duration-500">
          <div className="activity-header mb-2">
            <h2 className="activity-title text-2xl">{task.question}</h2>
            <p className="text-gray-500">Level {currentTask + 1} of {tasks.length}</p>
          </div>

          <BalanceScale leftWeight={task.left.weight} rightWeight={task.right.weight} />

          <div className="grid grid-cols-2 gap-4 max-w-sm mx-auto mt-12">
            <button
              onClick={() => handleChoice('left')}
              className={`p-6 rounded-2xl border-4 transition-all ${selection === 'left'
                ? (feedback === 'correct' ? 'border-green-500 bg-green-50 shadow-lg' : 'border-red-500 bg-red-50 animate-shake')
                : 'border-gray-200 bg-white hover:border-orange-400'
                }`}
            >
              <div className="text-4xl mb-2">{task.left.icon}</div>
              <div className="font-bold text-gray-700">{task.left.name}</div>
            </button>

            <button
              onClick={() => handleChoice('right')}
              className={`p-6 rounded-2xl border-4 transition-all ${selection === 'right'
                ? (feedback === 'correct' ? 'border-green-500 bg-green-50 shadow-lg' : 'border-red-500 bg-red-50 animate-shake')
                : 'border-gray-200 bg-white hover:border-orange-400'
                }`}
            >
              <div className="text-4xl mb-2">{task.right.icon}</div>
              <div className="font-bold text-gray-700">{task.right.name}</div>
            </button>
          </div>

          {feedback === 'correct' && (
            <div className="text-center mt-6 text-green-600 font-black animate-bounce">
              ‚ú® GREAT JOB! ‚ú®
            </div>
          )}
        </div>
      );
    }

    // ==================== ACTIVITY 8: LONG & SHORT ====================
    function Activity08_LongShort({ onComplete, onNext, activityNum, isCompleted }) {
      const [step, setStep] = useState('teaching');
      const [currentOrder, setCurrentOrder] = useState(0);
      const [selectedOrder, setSelectedOrder] = useState([]);

      const orderingTasks = [
        {
          items: [
            { id: 1, icon: 'üìè', length: 3, label: 'Short' },
            { id: 2, icon: 'üìè', length: 5, label: 'Medium' },
            { id: 3, icon: 'üìè', length: 8, label: 'Long' }
          ],
          correctOrder: [1, 2, 3] // Short to Long
        },
        {
          items: [
            { id: 4, icon: 'üñçÔ∏è', length: 2, label: 'Tiny' },
            { id: 5, icon: 'üñçÔ∏è', length: 6, label: 'Long' },
            { id: 6, icon: 'üñçÔ∏è', length: 4, label: 'Medium' }
          ],
          correctOrder: [4, 6, 5] // Tiny to Long
        },
        {
          items: [
            { id: 7, icon: 'üéÄ', length: 7, label: 'Long' },
            { id: 8, icon: 'üéÄ', length: 3, label: 'Short' },
            { id: 9, icon: 'üéÄ', length: 5, label: 'Medium' }
          ],
          correctOrder: [8, 9, 7] // Short to Long
        }
      ];

      const task = orderingTasks[currentOrder];

      const handleItemSelect = (itemId) => {
        if (selectedOrder.includes(itemId)) return;

        const newOrder = [...selectedOrder, itemId];
        setSelectedOrder(newOrder);

        if (newOrder.length === task.items.length) {
          const isCorrect = JSON.stringify(newOrder) === JSON.stringify(task.correctOrder);

          setTimeout(() => {
            if (isCorrect) {
              if (currentOrder < orderingTasks.length - 1) {
                setCurrentOrder(currentOrder + 1);
                setSelectedOrder([]);
              } else {
                onComplete(activityNum);
              }
            } else {
              setSelectedOrder([]);
            }
          }, 1000);
        }
      };

      if (step === 'teaching') {
        return (
          <div>
            <div className="activity-header">
              <h2 className="activity-title">Activity 8: Long & Short</h2>
              <p className="activity-subtitle">Ordering by length üìê</p>
            </div>
            <div className="teaching-module">
              <div className="guide-character">üë©‚Äçüè´</div>
              <div className="speech-bubble">
                <p className="text-lg mb-3">
                  <strong>Objects can be long or short!</strong>
                </p>
                <p className="text-base mb-3">
                  Let's put them in order from shortest to longest.
                </p>
                <div className="size-comparison my-6">
                  <div className="text-center">
                    <div className="size-bar" style={{ height: '60px' }}>
                      <div className="transform -rotate-90">Short</div>
                    </div>
                    <div className="mt-2 font-bold">Short</div>
                  </div>
                  <div className="text-center">
                    <div className="size-bar" style={{ height: '100px' }}>
                      <div className="transform -rotate-90">Medium</div>
                    </div>
                    <div className="mt-2 font-bold">Medium</div>
                  </div>
                  <div className="text-center">
                    <div className="size-bar" style={{ height: '140px' }}>
                      <div className="transform -rotate-90">Long</div>
                    </div>
                    <div className="mt-2 font-bold">Long</div>
                  </div>
                </div>
                <p className="text-base">
                  Click from SHORTEST to LONGEST!
                </p>
              </div>
            </div>
            <div className="text-center">
              <button className="btn-primary" onClick={() => setStep('practice')}>
                Let's Order! ‚ÜóÔ∏è
              </button>
            </div>
          </div>
        );
      }

      if (isCompleted) {
        return (
          <div className="text-center">
            <div className="feedback-correct">
              <p className="feedback-message">üéâ Length Expert!</p>
              <p>You can order by length!</p>
            </div>
            <button className="btn-primary" onClick={onNext}>
              Next Activity ‚Üí
            </button>
          </div>
        );
      }

      return (
        <div>
          <div className="activity-header">
            <h2 className="activity-title">Order from Shortest to Longest</h2>
            <p className="activity-subtitle">
              Task {currentOrder + 1} of {orderingTasks.length}
            </p>
          </div>

          <div className="text-center mb-6">
            <p className="text-lg font-bold mb-4">Click in order: Shortest ‚Üí Longest</p>

            <div className="size-comparison mb-6">
              {task.items.map(item => {
                const isSelected = selectedOrder.includes(item.id);
                const position = selectedOrder.indexOf(item.id) + 1;

                return (
                  <div key={item.id} className="text-center">
                    <div
                      className="size-bar mx-auto cursor-pointer hover:opacity-90 transition-opacity"
                      style={{
                        height: `${item.length * 20}px`,
                        background: isSelected ? '#10b981' : '#0ea5e9'
                      }}
                      onClick={() => handleItemSelect(item.id)}
                    >
                      {isSelected && (
                        <div className="text-white font-bold">{position}</div>
                      )}
                    </div>
                    <div className="mt-2 font-bold">{item.label}</div>
                    <div className="text-sm text-gray-600">Click {!isSelected ? 'me' : `#${position}`}</div>
                  </div>
                );
              })}
            </div>
          </div>

          {selectedOrder.length > 0 && (
            <div className="text-center">
              <div className="text-lg font-bold mb-2">Your order:</div>
              <div className="flex justify-center gap-2">
                {selectedOrder.map((itemId, index) => {
                  const item = task.items.find(i => i.id === itemId);
                  return (
                    <div key={index} className="text-center">
                      <div className="text-2xl">{index + 1}.</div>
                      <div className="text-3xl">{item?.icon}</div>
                      <div className="text-sm">{item?.label}</div>
                    </div>
                  );
                })}
              </div>

              {selectedOrder.length === task.items.length && (
                <div className="mt-4">
                  {JSON.stringify(selectedOrder) === JSON.stringify(task.correctOrder) ? (
                    <div className="feedback-correct">
                      <p className="feedback-message">‚úì Correct order!</p>
                    </div>
                  ) : (
                    <div className="feedback-incorrect">
                      <p className="feedback-message">Try again! Think about lengths.</p>
                    </div>
                  )}
                </div>
              )}
            </div>
          )}
        </div>
      );
    }


    // ==================== ACTIVITY 9: SIZE RULERS ====================
    function Activity09_SizeRulers({ onComplete, onNext, activityNum, isCompleted }) {
      const [step, setStep] = useState('teaching');
      const [currentRuler, setCurrentRuler] = useState(0);
      const [selectedLength, setSelectedLength] = useState(null);

      const rulerProblems = [
        { object: 'üìè', length: 3, unit: 'units' },
        { object: 'üñçÔ∏è', length: 5, unit: 'units' },
        { object: '‚úÇÔ∏è', length: 2, unit: 'units' },
        { object: 'üìé', length: 4, unit: 'units' }
      ];

      const problem = rulerProblems[currentRuler];
      const lengthOptions = [1, 2, 3, 4, 5, 6];

      const handleLengthSelect = (length) => {
        setSelectedLength(length);

        if (length === problem.length) {
          setTimeout(() => {
            if (currentRuler < rulerProblems.length - 1) {
              setCurrentRuler(currentRuler + 1);
              setSelectedLength(null);
            } else {
              onComplete(activityNum);
            }
          }, 1000);
        }
      };

      if (step === 'teaching') {
        return (
          <div>
            <div className="activity-header">
              <h2 className="activity-title">Activity 9: Reading Rulers</h2>
              <p className="activity-subtitle">Simple measurement üìè</p>
            </div>
            <div className="teaching-module">
              <div className="guide-character">üë©‚Äçüè´</div>
              <div className="speech-bubble">
                <p className="text-lg mb-3">
                  <strong>Rulers help us measure length!</strong>
                </p>
                <p className="text-base mb-3">
                  Each mark is one unit.
                </p>
                <div className="measurement-ruler my-6">
                  {[0, 1, 2, 3, 4, 5, 6].map(i => (
                    <div key={i}>
                      <div className="ruler-tick" style={{ left: `${(i / 6) * 100}%` }}></div>
                      {i > 0 && (
                        <div className="ruler-number" style={{ left: `${(i / 6) * 100}%` }}>
                          {i}
                        </div>
                      )}
                    </div>
                  ))}
                  <div
                    className="absolute top-0 left-0 h-full bg-blue-500 opacity-50"
                    style={{ width: '50%' }}
                  ></div>
                </div>
                <p className="text-base">
                  This blue bar is 3 units long!
                </p>
              </div>
            </div>
            <div className="text-center">
              <button className="btn-primary" onClick={() => setStep('practice')}>
                Let's Read Rulers! üìê
              </button>
            </div>
          </div>
        );
      }

      if (isCompleted) {
        return (
          <div className="text-center">
            <div className="feedback-correct">
              <p className="feedback-message">üéâ Ruler Reader!</p>
              <p>You can read simple measurements!</p>
            </div>
            <button className="btn-primary" onClick={onNext}>
              Complete Level 5! üéâ
            </button>
          </div>
        );
      }

      return (
        <div>
          <div className="activity-header">
            <h2 className="activity-title">How long is this?</h2>
            <p className="activity-subtitle">
              Measurement {currentRuler + 1} of {rulerProblems.length}
            </p>
          </div>

          <div className="text-center mb-6">
            <div className="text-5xl mb-4">{problem.object}</div>
            <p className="text-xl font-bold">How many units long?</p>
          </div>

          <div className="measurement-ruler mb-8">
            {[0, 1, 2, 3, 4, 5, 6].map(i => (
              <div key={i}>
                <div className="ruler-tick" style={{ left: `${(i / 6) * 100}%` }}></div>
                {i > 0 && (
                  <div className="ruler-number" style={{ left: `${(i / 6) * 100}%` }}>
                    {i}
                  </div>
                )}
              </div>
            ))}
            <div
              className="absolute top-0 left-0 h-full bg-blue-500 opacity-70"
              style={{ width: `${(problem.length / 6) * 100}%` }}
            ></div>
            <div className="absolute top-0 left-0 w-full h-full flex items-center justify-center">
              <div className="text-3xl text-white font-bold">{problem.object}</div>
            </div>
          </div>

          <div className="number-pad" style={{ gridTemplateColumns: 'repeat(3, 1fr)' }}>
            {lengthOptions.map(length => (
              <button
                key={length}
                className={`number-pad-btn ${selectedLength === length ? (length === problem.length ? 'correct' : 'incorrect') : ''}`}
                onClick={() => handleLengthSelect(length)}
              >
                {length}
              </button>
            ))}
          </div>

          <div className="text-center mt-4">
            <div className="flex justify-center gap-2">
              {rulerProblems.map((_, i) => (
                <div
                  key={i}
                  className={`w-4 h-4 rounded-full ${i < currentRuler ? 'bg-green-500' : i === currentRuler ? 'bg-blue-500' : 'bg-gray-300'}`}
                />
              ))}
            </div>
          </div>
        </div>
      );
    }
    // ==================== ACTIVITY 10: FINAL MIXED CHALLENGE ====================
    function Activity10_MixedChallenge({ onComplete, onNext, activityNum, isCompleted }) {
      const [currentQ, setCurrentQ] = React.useState(0);
      const [selected, setSelected] = React.useState(null);
      const [feedback, setFeedback] = React.useState(null);

      const questions = [
        // --- MEASUREMENT (2) ---
        {
          type: "measurement",
          prompt: "Which object is LONGER?",
          options: [
            { label: "üìè Short Ruler", value: "short" },
            { label: "üìèüìè Long Ruler", value: "long" }
          ],
          correct: "long"
        },
        {
          type: "measurement",
          prompt: "Which one is HEAVIER?",
          options: [
            { label: "ü™∂ Feather", value: "light" },
            { label: "üß± Brick", value: "heavy" }
          ],
          correct: "heavy"
        },

        // --- MONEY (2) ---
        {
          type: "money",
          prompt: "Which has MORE value?",
          options: [
            { label: "5 coin", value: 5 },
            { label: "10 coin", value: 10 }
          ],
          correct: 10
        },
        {
          type: "money",
          prompt: "Choose the correct amount",
          options: [
            { label: "üí∏üí∏ + üí∏ = üí∏üí∏üí∏", value: 3 },
            { label: " üí∏üí∏üí∏+ üí∏ = üí∏üí∏üí∏", value: 4 }
          ],
          correct: 3
        },

        // --- TIME (2) ---
        {
          type: "time",
          prompt: "Which clock shows 3 o'clock?",
          options: [
            { label: "üïí", value: 3 },
            { label: "üïï", value: 6 }
          ],
          correct: 3
        },
        {
          type: "time",
          prompt: "What time is shown?",
          options: [
            { label: "üïò 9:00", value: "9" },
            { label: "üïõ 12:00", value: "12" }
          ],
          correct: "9"
        }
      ];

      const question = questions[currentQ];

      const handleSelect = (value) => {
        if (feedback) return;
        setSelected(value);

        if (value === question.correct) {
          setFeedback("correct");
          setTimeout(() => {
            if (currentQ < questions.length - 1) {
              setCurrentQ(currentQ + 1);
              setSelected(null);
              setFeedback(null);
            } else {
              onComplete(activityNum);
            }
          }, 1000);
        } else {
          setFeedback("incorrect");
          setTimeout(() => {
            setSelected(null);
            setFeedback(null);
          }, 800);
        }
      };

      // üîπ ADDED: simple visual clock (hour hand only)
      const SimpleClock = ({ hour }) => {
        const rotation = hour * 30;

        return (
          <div className="simple-clock my-6">
            <div className="clock-center"></div>
            <div
              className="hour-hand"
              style={{ transform: `translate(-50%, -100%) rotate(${rotation}deg)` }}
            />
          </div>
        );
      };

      if (isCompleted) {
        return (
          <div className="text-center py-10">
            <div className="feedback-correct">
              <p className="feedback-message">üèÜ Final Challenge Complete!</p>
              <p>You mastered Time, Money & Measurement!</p>
            </div>
            <button className="btn-primary mt-6" onClick={onNext}>
              Finish Level ‚Üí
            </button>
          </div>
        );
      }

      return (
        <div>
          <div className="activity-header">
            <h2 className="activity-title">Final Challenge üéØ</h2>
            <p className="activity-subtitle">
              Question {currentQ + 1} of {questions.length}
            </p>
          </div>

          <div className="text-center mb-6">
            <p className="text-xl font-bold">{question.prompt}</p>
          </div>

          {/* üîπ ADDED: clock shown only for time questions */}
          {question.type === "time" && (
            <SimpleClock hour={Number(question.correct)} />
          )}

          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-md mx-auto">
            {question.options.map((opt, i) => (
              <button
                key={i}
                className={`choice-button ${selected === opt.value
                  ? feedback === "correct"
                    ? "correct"
                    : "incorrect"
                  : ""
                  }`}
                onClick={() => handleSelect(opt.value)}
              >
                <div className="text-3xl mb-2">{opt.label}</div>
              </button>
            ))}
          </div>

          {feedback === "correct" && (
            <div className="text-center mt-6 text-green-600 font-bold animate-bounce">
              ‚úì Correct!
            </div>
          )}

          <div className="flex justify-center gap-2 mt-8">
            {questions.map((_, i) => (
              <div
                key={i}
                className={`h-2 w-8 rounded-full ${i < currentQ
                  ? "bg-green-500"
                  : i === currentQ
                    ? "bg-blue-500"
                    : "bg-gray-300"
                  }`}
              />
            ))}
          </div>
        </div>
      );
    }

    // ==================== COMPLETION SCREEN ====================
    function CompletionScreen({ rewards, onFinish }) {
      return (
        <div className="completion-screen">
          <div className="completion-trophy">üèÜ</div>
          <h1 className="completion-title">Math Master Achieved!</h1>
          <p className="completion-message">
            You completed all Math Master Trail activities!
          </p>
          <div className="rewards-container mb-8">
            <div className="reward-badge">
              <span className="reward-icon">‚≠ê</span>
              <span>{rewards.stars} Stars</span>
            </div>
            <div className="reward-badge">
              <span className="reward-icon">üèÖ</span>
              <span>{rewards.badges} Badges</span>
            </div>
            <div className="reward-badge">
              <span className="reward-icon">üé®</span>
              <span>{rewards.tokens} Tokens</span>
            </div>
          </div>
          <div className="space-y-4">
            <p className="text-lg text-gray-700">
              You learned real-world math skills:
            </p>
            <div className="grid grid-cols-3 gap-4 text-center">
              <div className="p-4 bg-blue-50 rounded-xl">
                <div className="text-3xl">üï∞Ô∏è</div>
                <div className="font-bold">Time</div>
              </div>
              <div className="p-4 bg-yellow-50 rounded-xl">
                <div className="text-3xl">üí∞</div>
                <div className="font-bold">Money</div>
              </div>
              <div className="p-4 bg-purple-50 rounded-xl">
                <div className="text-3xl">üìè</div>
                <div className="font-bold">Measurement</div>
              </div>
            </div>
            <p className="text-lg font-bold text-blue-600">
              You're a Real-World Math Master! üåü
            </p>
          </div>
          <button className="btn-primary mt-8" onClick={onFinish}>
            Complete Level 5 üéâ
          </button>
        </div>
      );
    }

    // ==================== RENDER APP ====================
    const root = ReactDOM.createRoot(document.getElementById('math-trail-root'));
    root.render(<MathMasterTrailLevel />);
  </script>

  <script>
    const TOTAL_LEVELS = 5;

    const match = window.location.pathname.match(/level-(\d+)/);
    const LEVEL_NUMBER = match ? Number(match[1]) : null;

    if (!LEVEL_NUMBER || LEVEL_NUMBER < 1 || LEVEL_NUMBER > TOTAL_LEVELS) {
      window.location.href = "../roadmap.html";
    }

    const storedLevel = Number(localStorage.getItem("arithmoLevel")) || 1;

    if (storedLevel !== LEVEL_NUMBER) {
      window.location.href = "../roadmap.html";
    }

    function completeLevel() {
      if (storedLevel < TOTAL_LEVELS) {
        localStorage.setItem("arithmoLevel", storedLevel + 1);
      }
      window.location.href = "../roadmap.html";
    }
  </script>

  <script src="../assets/script.js"></script>

  <!-- Progress Manager -->
  <script src="../assets/progress-manager.js"></script>

  <!-- Add global helper -->
  <script>
    // Make saveActivityProgress available globally
    if (!window.saveActivityProgress) {
      window.saveActivityProgress = async function (level, activity, rewards = {}, isCompleted = false) {
        if (window.ArithmoProgress) {
          return await window.ArithmoProgress.saveActivityProgress(level, activity, rewards, isCompleted);
        }
        return null;
      };
    }
  </script>

</body>

</html>